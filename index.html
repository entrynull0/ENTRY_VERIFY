<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ENTRY Verification</title>

<!-- Favicon: ENTRY green on black background -->
<!-- آیکون ENTRY سبز روی بک‌گراند مشکی -->
<link
  rel="icon"
  type="image/svg+xml"
  href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' fill='%23000'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='monospace' font-size='18' fill='%2300ff00'%3EENTRY_%3C/text%3E%3C/svg%3E"
/>

<style>
    body {
        background: black;
        color: #00ff00;
        font-family: monospace;
        overflow: hidden;
        text-align: center;
        padding-top: 120px;
    }
    canvas {
        position: fixed;
        top: 0;
        left: 0;
        z-index: -1;
    }
    .panel {
        background: rgba(0, 0, 0, 0.6);
        padding: 25px 40px;
        border: 1px solid #00ff00;
        display: inline-block;
        border-radius: 8px;
        margin-bottom: 20px;
        min-width: 320px;
    }
    select, button {
        background: black;
        border: 1px solid #00ff00;
        color: #00ff00;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 10px;
    }
    #walletAddress {
        margin-top: 15px;
        font-size: 14px;
        color: #00ff00;
        word-break: break-all;
    }
    #status {
        margin-top: 15px;
        font-size: 14px;
    }
    .error { color: #ff5555; }
    .success { color: #00ff00; }
</style>
</head>
<body>

<canvas id="matrix"></canvas>

<div class="panel">
    <h1>ENTRY Wallet Verification</h1>
    <p>Connect your Solana wallet to continue</p>

    <p id="paramsStatus"></p>

    <select id="walletSelect">
        <option value="phantom">Phantom</option>
        <option value="solflare">Solflare</option>
        <option value="backpack">Backpack</option>
        <option value="glow">Glow</option>
        <option value="nightly">Nightly</option>
        <option value="ledger">Ledger (via Phantom/Backpack)</option>
    </select>

    <br>
    <button id="connect">Connect Wallet</button>

    <div id="walletAddress"></div>
    <div id="status"></div>
</div>

<script>
// ================= Matrix background =================
// پس‌زمینه ماتریکس
const canvas = document.getElementById("matrix");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
    canvas.height = window.innerHeight;
    canvas.width = window.innerWidth;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

const chars = "01";
let columns = Math.floor(window.innerWidth / 10);
let drops = Array(columns).fill(1);

function draw() {
    ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = "#00ff00";
    ctx.font = "15px monospace";

    drops.forEach((y, i) => {
        const text = chars[Math.floor(Math.random() * chars.length)];
        ctx.fillText(text, i * 10, y * 20);

        if (y * 20 > canvas.height && Math.random() > 0.975) drops[i] = 0;
        drops[i]++;
    });
}
setInterval(draw, 33);

// ================= URL params =================
// گرفتن پارامترهای URL (discord_id + wallet)
const urlParams = new URLSearchParams(window.location.search);
const discordId = urlParams.get("discord_id");
const walletFromBot = urlParams.get("wallet");

const paramsStatus = document.getElementById("paramsStatus");

if (!discordId || !walletFromBot) {
    paramsStatus.innerText = "Missing discord_id or wallet in URL.";
    // پارامتر discord_id یا wallet در URL نیست
    paramsStatus.className = "error";
} else {
    paramsStatus.innerText = "Discord ID and wallet detected.";
    // Discord ID و ولت شناسایی شد
    paramsStatus.className = "success";
}

// ================= Helpers =================
// توابع کمکی
function setStatus(msg, type = "") {
    const el = document.getElementById("status");
    el.innerText = msg;
    el.className = type;
}

function setWalletAddress(addr) {
    const el = document.getElementById("walletAddress");
    el.innerText = addr ? "Connected Wallet: " + addr : "";
}

// ================= Wallet providers =================
// انتخاب ولت
function getProvider(choice) {
    switch (choice) {
        case "phantom":
            if (window.solana && window.solana.isPhantom) return window.solana;
            break;
        case "solflare":
            if (window.solflare) return window.solflare;
            break;
        case "backpack":
            if (window.backpack && window.backpack.isBackpack) return window.backpack;
            break;
        case "glow":
            if (window.glowSolana) return window.glowSolana;
            break;
        case "nightly":
            if (window.nightly) return window.nightly;
            break;
        case "ledger":
            alert("Ledger usually managed via Phantom/Backpack.");
            // Ledger معمولاً از طریق Phantom/Backpack مدیریت می‌شود
            return null;
    }
    return null;
}

// ================= Connect + Sign =================
// اتصال به ولت و امضای پیام
document.getElementById("connect").onclick = async () => {
    setStatus("", "");
    setWalletAddress("");

    if (!discordId || !walletFromBot) {
        setStatus("URL missing required parameters.", "error");
        // پارامترهای لازم در URL نیست
        return;
    }

    const choice = document.getElementById("walletSelect").value;
    const provider = getProvider(choice);

    if (!provider) {
        setStatus("Selected wallet extension not found.", "error");
        // ولت انتخاب‌شده پیدا نشد
        return;
    }

    try {
        // Connect to wallet / اتصال به ولت
        await provider.connect();
        const publicKey = provider.publicKey.toString();
        setWalletAddress(publicKey);

        // Create message to prevent spoofing / ساخت پیام برای جلوگیری از Spoofing
        const message = `ENTRY_VERIFY:${discordId}:${walletFromBot}`;
        const encodedMessage = new TextEncoder().encode(message);

        if (!provider.signMessage) {
            setStatus("Wallet does not support signing.", "error");
            // این ولت قابلیت امضای پیام ندارد
            return;
        }

        // Sign message / امضای پیام
        const signature = await provider.signMessage(encodedMessage, "utf8");
        const sigBytes = signature.signature || signature;
        const sigBase64 = btoa(String.fromCharCode(...sigBytes));

        // Show result on page (no API) / نمایش نتیجه روی صفحه (بدون API)
        setStatus("✅ Message signed.\nSignature: " + sigBase64, "success");

    } catch (err) {
        console.error(err);
        setStatus("Wallet connection or signing failed.", "error");
        // اتصال یا امضای ولت شکست خورد
    }
};
</script>

</body>
</html>
